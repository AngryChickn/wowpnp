var Filter=new function(){var self=this;var constants={checkFilterContentEvents:"change keyup keydown click",elementIds:{filtersWrapper:"filter-filters",presetsWrapper:"filter-presets",weightsWrapper:"filter-weights"},elementNames:{filterType:"filter-type",filterSelect:"filter-select",filterValue:"filter-value"},maxFilters:5,presetSpecId:"sdkgnsdkn436"};var status={page:"",menuPath:null,customUrl:null,categories:[],categoryPath:"",completePath:"",lastCategoryId:null,facets:[],presetFacets:{},activeFacets:{},filters:[],presetFilters:[],activeFilters:[],matchType:"all",weights:null,weightsFactor:null,weightsGemScores:null,extraListviewColumns:null};var filterDropdowns={patches:[],patchDates:{}};this.init=function(config){status.page=config.page;status.customUrl=config.customUrl;status.categories=config.categories;status.facets=config.facets;status.filters=config.filters;status.categoryPath=config.categoryPath;status.completePath=config.completePath;status.lastCategoryId=config.lastCategoryId;status.presetFacets=config.activeFacets instanceof Array?{}:config.activeFacets;status.presetFilters=config.activeFilters;status.matchType=config.matchType;if(config.menuPath){status.menuPath=config.menuPath}if(config.weightsGemScores){status.weightsGemScores=config.weightsGemScores}else{if(typeof items_weightsGemScores!="undefined"){status.weightsGemScores=items_weightsGemScores}}compareFilterObjects();if(status.filters.length){self.filters_initSection(WH.ge(constants.elementIds.filtersWrapper),constants.elementNames.filterType)}if(status.page=="items"&&typeof items_weightingAllowed!="undefined"&&items_weightingAllowed){var presetsWrapper=WH.ge(constants.elementIds.presetsWrapper);if(presetsWrapper){self.weights_init(presetsWrapper);self.filters_initSection(WH.ge(constants.elementIds.weightsWrapper),"weights[]")}}utility_updateMenus();utility_enableFilterContentChecks('#fi .filter-table input[type="text"], #fi .filter-table input[type="password"], #fi .filter-table select, #fi .filter-table textarea, #fi .filter-side select');if(!config.noInputFocus){utility_focusFirstTextInput()}filters_setAll()};this.submit=function(){status.matchType=$("#filter-match-any").is(":checked")?"any":"all";status.activeFacets={};status.activeFilters=[];var filterSum=0;var elements=this.elements;for(var i=0,element;element=elements[i];i++){switch(element.name){case constants.elementNames.filterType:var filterId=$(element).val();if(filterId!=""){status.activeFilters.push({id:filterId})}continue;case constants.elementNames.filterSelect:if(status.activeFilters.length){if(typeof status.activeFilters[status.activeFilters.length-1].select!="undefined"){status.activeFilters.push({})}status.activeFilters[status.activeFilters.length-1].select=$(element).val();if(!status.activeFilters[status.activeFilters.length-1].summed){status.activeFilters[status.activeFilters.length-1].summed=true;filterSum++}}continue;case constants.elementNames.filterValue:if(status.activeFilters.length){if(typeof status.activeFilters[status.activeFilters.length-1].value!="undefined"){status.activeFilters.push({})}status.activeFilters[status.activeFilters.length-1].value=$(element).val();if(!status.activeFilters[status.activeFilters.length-1].summed){status.activeFilters[status.activeFilters.length-1].summed=true;filterSum++}}continue}switch(element.nodeName){case"INPUT":switch(element.type){case"text":if(WH.trim(element.value).length>0){if(element.name=="weight-values[]"){if(status.activeFacets["weight-values"]){status.activeFacets["weight-values"].value+=":"+WH.trim(element.value)}else{status.activeFacets["weight-values"]={value:WH.trim(element.value)}}}else{status.activeFacets[element.name]={value:WH.trim(element.value)}}}break;case"checkbox":var extendedName=element.name.match(/^(.*)-extended$/);if(extendedName&&element.checked&&element.value=="on"){if(status.activeFacets[extendedName[1]]){status.activeFacets[extendedName[1]].extended=true}break}if(element.value=="ja"&&element.checked){status.activeFacets[element.name]={value:"yes"};break}if(element.checked&&element.value){status.activeFacets[element.name]={value:element.value}}break;case"radio":if(element.name!="filter-match"&&element.checked&&element.value){status.activeFacets[element.name]={value:element.value}}break;case"hidden":if(element.value!==""){status.activeFacets[element.name]={value:WH.trim(element.value)}}break;default:if(WH.isDev()){console.log("Unknown input type:",element.type,element)}break}break;case"SELECT":if(element.name=="weights[]"){if(status.activeFacets.weights){status.activeFacets.weights.value+=":"+WH.trim(element.value)}else{status.activeFacets.weights={value:WH.trim(element.value)}}}else{if(element.name!="gems"&&element.selectedIndex!=-1&&element.options[element.selectedIndex].value){if(element.multiple){var values=[];for(var l=0,select;select=element.options[l];l++){if(select.selected){values.push(select.value)}}status.activeFacets[element.name]={value:values.join(":")}}else{status.activeFacets[element.name]={value:element.options[element.selectedIndex].value}}}}break;case"SUBMIT":case"BUTTON":break;default:if(WH.isDev()){console.log("Skipping unhandled form element:",element.type,element)}break}}if(status.activeFacets.weights&&status.activeFacets.weights.value===""){delete status.activeFacets.weights;delete status.activeFacets["weight-values"]}var gets=WH.getGets();if(filterSum==0&&$.isEmptyObject(status.activeFacets)&&!gets.filter&&$.isEmptyObject(status.presetFacets)){alert(LANG.message_fillsomecriteria);return false}var baseUrl="/"+status.page+status.categoryPath;var url=status.customUrl?"/"+status.customUrl:baseUrl;if(!$.isEmptyObject(status.activeFacets)){var path=status.categoryPath.replace(/^\/+/,"").split("/");var currentCategoryTier=path.length&&path[0]!=""?path.length:0;var categoryFacets="";var normalFacets="";for(var j=0,facet;facet=status.facets[j];j++){if(status.activeFacets[facet.id]){var facetValue=status.activeFacets[facet.id].value;if(facet.falsePrefix&&facetValue.substr(0,facet.falsePrefix.length)==facet.falsePrefix){facetValue=facetValue.substr(facet.falsePrefix.length)}if(facet.falseSuffix&&facetValue.substr(-1*facet.falseSuffix.length,facet.falseSuffix.length)==facet.falseSuffix){facetValue=facetValue.substr(0,facetValue.length-facet.falseSuffix.length)}if(facet.categoryTier){if(facet.categoryTier&&currentCategoryTier+1==facet.categoryTier.level&&status.activeFacets[facet.id].value.indexOf(":")==-1){var useAsCategory=true;if(facet.categoryTier.hasOwnProperty("parent")&&status.lastCategoryId!==null&&status.lastCategoryId!=facet.categoryTier.parent){useAsCategory=false}if(useAsCategory){categoryFacets+="/"+facet.categoryTier.names[facetValue];continue}}}normalFacets+="/"+facet.id;if(status.activeFacets[facet.id].extended){normalFacets+="-extended"}normalFacets+=":"+utility_prepareValueForUrl(facetValue,true)}}if(categoryFacets&&status.categoryPath+categoryFacets!=status.completePath){url=baseUrl+categoryFacets}url+=normalFacets}if(filterSum>0){var filterIds=[];var filterSelects=[];var filterValues=[];for(var k=0,filter;filter=status.activeFilters[k];k++){if(filter.id&&typeof filter.select!="undefined"||typeof filter.value!="undefined"){filterIds.push(utility_prepareValueForUrl(filter.id));filterSelects.push(typeof filter.select!="undefined"?utility_prepareValueForUrl(filter.select):0);filterValues.push(typeof filter.value!="undefined"?utility_prepareValueForUrl(filter.value):"")}}if(filterIds.length){url+="?filter"+(filterSum>1&&status.matchType!="all"?"-"+status.matchType:"")+"="+filterIds.join(":")+";"+filterSelects.join(":")+";"+filterValues.join(":")}}window.location=url;return false};this.reset=function(){filters_resetAll(WH.ge(constants.elementIds.filtersWrapper));filters_resetAll(WH.ge(constants.elementIds.weightsWrapper));var specPresets=WH.ge(constants.presetSpecId);if(specPresets){specPresets.parentNode.style.display="none";while(specPresets.firstChild){WH.de(specPresets.firstChild)}WH.ae(specPresets,WH.ce("option"))}var elements=this.elements;for(var i=0,element;element=elements[i];i++){switch(element.nodeName){case"INPUT":if(element.type=="text"){element.value=""}else{if(element.type=="checkbox"){element.checked=false}else{if(element.type=="radio"&&element.value.length==0){element.checked=true}}}break;case"SELECT":element.selectedIndex=element.multiple?-1:0;if(element.i){element.i=element.selectedIndex}break}}return false};this.facets_clear=function(cssSelector){$(cssSelector).val("").change()};this.filters_initSection=function(wrapper,selectName){var div=wrapper.firstChild;var select=WH.ce("select");select.name=selectName;select.onchange=select.onkeyup=filters_onChange.bind(null,select);WH.ae(select,WH.ce("option",{value:"",text:LANG.fiadditionalfilters+LANG.ellipsis}));var optGroup=null;var localeStrings=LANG["filters_"+status.page.replace(/-/g,"_")];for(var i=0,filter;filter=status.filters[i];i++){if(!(g_user.roles&U_GROUP_EMPLOYEE)&&filter.staffonly){continue}if(!filter.type){if(optGroup&&optGroup.childNodes.length>0){WH.ae(select,optGroup)}optGroup=WH.ce("optgroup");optGroup.label=LANG.traits[filter.name]||localeStrings[filter.name]}else{if(selectName!="weights[]"||(filter.type=="num"&&!filter.noweights)){var option=WH.ce("option");option.value=filter.id;var name=LANG.traits[filter.name]?LANG.traits[filter.name][0]:localeStrings[filter.name];if(filter.indent){name="- "+name}WH.ae(option,WH.ct(name));WH.ae(optGroup,option)}}}if(optGroup&&optGroup.childNodes.length>0){WH.ae(select,optGroup)}utility_enableFilterContentChecks(select);WH.ae(div,select);filters_updateFilterCount()};this.filters_add=function(typeWrapper,cr){var a=typeWrapper.childNodes[0].lastChild;if(a.nodeName!="A"){filters_appendRemoveLink(typeWrapper.childNodes[0])}else{a.className="filter-remove";a.firstChild.nodeValue=LANG.firemove;a.onclick=filters_remove}var newDiv=WH.ce("div");var filterSelector=typeWrapper.childNodes[0].childNodes[0].cloneNode(true);filterSelector.onchange=filterSelector.onkeyup=filters_onChange.bind(null,filterSelector);filterSelector.i=null;if(cr!=null){var options=filterSelector.getElementsByTagName("option");for(var i=0,option;option=options[i];i++){if(option.value==cr){option.selected=true;break}}}else{filterSelector.firstChild.selected=true}utility_enableFilterContentChecks(filterSelector);newDiv.appendChild(filterSelector);filters_appendRemoveLink(newDiv,filterSelector.firstChild.selected);typeWrapper.appendChild(newDiv);filters_updateFilterCount();return filterSelector};this.filters_lookup=function(value){if(!self.filters_lookup.cache){self.filters_lookup.cache={};for(var i=0,filter;filter=status.filters[i];i++){if(!(g_user.roles&U_GROUP_EMPLOYEE)&&filter.staffonly){continue}self.filters_lookup.cache[filter.id]=filter;self.filters_lookup.cache[filter.name]=filter}}if(value&&typeof value=="string"){var firstChar=value.charCodeAt(0);if(firstChar>="0".charCodeAt(0)&&firstChar<="9".charCodeAt(0)){value=parseInt(value)}}return self.filters_lookup.cache[value]};this.listview_initWeightedListview=function(){this._scoreMode=this._upgradeIds?2:0;if(this.sort[0]==-this.columns.length){this.applySort()}if(this._upgradeIds&&this._minScore){this._maxScore=this._minScore}};this.listview_filterUpgrades=function(item,i){var nResults=25;if(!this._upgradeIds){return i<nResults}if(this._upgradeRow==null){this._upgradeRow=nResults-1}if(listview_isItemFromFindUpgrades(this,item)){if(i<nResults){this._upgradeRow++}return true}return i<this._upgradeRow};this.listview_addUpgradeIndicator=function(){if(this._upgradeIds){var match=location.href.match(/\bupgrade-for:([0-9]+)\b/);var upgradeId=match&&match[1]||false;if(upgradeId===false){return}for(var i=0,item;item=this.data[i];i++){var newUpgrade=upgradeId.replace(item.id,"").replace(/(^:*|:*$)/g,"").replace("::",":");if(listview_isItemFromFindUpgrades(this,item)){this.createIndicator(WH.sprintf(LANG.lvnote_upgradesfor,item.id+(item.bonuses?("&bonus="+item.bonuses.join(":")):""),8-parseInt(item.name.charAt(0)),item.name.substr(1)),location.href.replace("/upgrade-for:"+upgradeId,(newUpgrade?"/upgrade-for:"+newUpgrade:"")))}}}};this.listview_getExtraItemColumns=function(filterColumns,gemQuality,showCost){if(!filterColumns.length){return null}var extraColumns=[];var maxColumnCount=10;if(status.weightsFactor){maxColumnCount--}if(gemQuality){maxColumnCount--}if(showCost){maxColumnCount--}for(var i=0,filterColumn;(filterColumn=filterColumns[i])&&i<maxColumnCount;i++){var filter=self.filters_lookup(filterColumn);if(filter&&filter.name&&filter.type=="num"&&filter.name!="purchasablewithcopper"){var columnConfig={id:filter.name,value:filter.name,name:(LANG.traits[filter.name]?LANG.traits[filter.name][2]:LANG.filters_items[filter.name]),tooltip:(LANG.traits[filter.name]?LANG.traits[filter.name][0]:LANG.filters_items[filter.name]),before:(filter.before?filter.before:"source"),compute:function(item,td,tr,realI){item.quality=8-item.name[0];var forceItemLevel=this.ilvlOverride?(typeof this.ilvlOverride.value=="function"?this.ilvlOverride.value.call(this,item):this.ilvlOverride.value):null;item=WH.applyStatModifications(item,null,null,forceItemLevel,Listview.funcBox.getCurrentItemBonuses.call(this,item));return item[this.columns[realI].value]?item[this.columns[realI].value]:-1}};extraColumns.push(columnConfig)}}if(status.weightsFactor){if(gemQuality){extraColumns.push({id:"gems",name:LANG.gems,getValue:function(item){return item.gems.length},compute:function(item,td){item=WH.applyStatModifications(item,null,null,null,Listview.funcBox.getCurrentItemBonuses.call(this,item));if(!item.nsockets||!item.gems){return}var sockets=[];for(var i=0;i<item.nsockets;i++){sockets.push(item["socket"+(i+1)])}var bonusText="";var count=0;for(var stat in item.socketbonusstat){if(item.socketbonusstat.hasOwnProperty(stat)&&LANG.traits[stat]){if(count++>0){bonusText+=", "}bonusText+="+"+item.socketbonusstat[stat]+" "+LANG.traits[stat][2]}}Listview.funcBox.createSocketedIcons(sockets,td,item.gems,item.matchSockets,bonusText)},sortFunc:function(a,b,col){return WH.stringCompare((a.gems?a.gems.length:0),(b.gems?b.gems.length:0))}})}extraColumns.push({id:"score",name:LANG.score,width:"7%",value:"score",compute:function(item,td){var a=WH.ce("a");a.href="javascript:;";td.onclick=weights_updateScores.bind(this);a.className=(item.gemGain>0?"q2":"q1");WH.ae(a,WH.ct(weights_convertScore(item.score,this._scoreMode,this._maxScore)));WH.ae(td,a)},sortFunc:function(a,b){return WH.stringCompare(a.score,b.score)}})}if(showCost){extraColumns.push(Listview.extraCols.cost)}status.extraListviewColumns=extraColumns.length;return extraColumns};this.listview_getExtraItemColumnCount=function(){return status.extraListviewColumns};this.listview_getExtraReputationColumns=function(factions){var res=[];for(var i=0,faction;faction=factions[i];i++){var name=faction[1];if(name.length>15){var words=faction[1].split(" ");for(var j=0,word;word=words[j];j++){if(word.length>3){name=word.length>15?word.substring(0,12)+"...":word;break}}}var col={id:"faction-"+faction[0],name:name,tooltip:faction[1],type:"num",before:"category"};eval("col.getValue = function(quest) { return Listview.funcBox.getQuestReputation("+faction[0]+", quest) }");eval("col.compute = function(quest, td) { return Listview.funcBox.getQuestReputation("+faction[0]+", quest) }");eval("col.sortFunc = function(a, b, col) { var _ = Listview.funcBox.getQuestReputation; return WH.stringCompare(_("+faction[0]+", a), _("+faction[0]+", b)) }");res.push(col)}return res};this.listview_computeItemScores=function(listview){for(var i in listview.data){if(!listview.data.hasOwnProperty(i)){continue}var dataRow=listview.data[i];dataRow.__tr=null;var forceItemLevel=listview.ilvlOverride?(typeof listview.ilvlOverride.value=="function"?listview.ilvlOverride.value.call(listview,dataRow):listview.ilvlOverride.value):null;var modedItem=WH.applyStatModifications(dataRow,null,null,forceItemLevel,Listview.funcBox.getCurrentItemBonuses.call(listview,dataRow));var score=0;if(status.weights!=null&&status.weightsFactor){for(var j in status.weights){if(status.weights.hasOwnProperty(j)&&modedItem[j]){score+=modedItem[j]*status.weights[j]/status.weightsFactor}}dataRow.score=score;self.listview_computeSocketScores.call(listview,dataRow,modedItem)}}};this.listview_computeSocketScores=function(item,modifiedItem){var listview=this;if(!status.weightsGemScores&&typeof items_weightsGemScores!="undefined"&&items_weightsGemScores){status.weightsGemScores=items_weightsGemScores}if(status.weightsGemScores!=null){var match=0,best=0,sock=0;var mGems=[],bGems=[];var mUniq=[],bUniq=[];var mSock={},bSock={};var noMatch=false;var modedItem=modifiedItem||WH.applyStatModifications(item,null,null,null,Listview.funcBox.getCurrentItemBonuses.call(listview,item));for(var i=1;i<=3;++i){var n=modedItem["socket"+i],s=(n==1?1:0);if(n){if(status.weightsGemScores[n]){for(var j=0;j<status.weightsGemScores[n].length;++j){var t=status.weightsGemScores[n][j];if(t.socketLevel<=modedItem.level&&(t.uniqEquip==0||WH.inArray(mUniq,t.id)<0)){match+=t.score;mGems.push(t.id);mSock[i-1]=1;if(t.uniqEquip==1){mUniq.push(t.id)}break}}}else{noMatch=true}if(status.weightsGemScores[s]){for(var k=0;k<status.weightsGemScores[s].length;++k){var t=status.weightsGemScores[s][k];if(t.socketLevel<=modedItem.level&&(t.uniqEquip==0||WH.inArray(bUniq,t.id)<0)){best+=t.score;bGems.push(t.id);bSock[i-1]=(t.colors&n);if(t.uniqEquip==1){bUniq.push(t.id)}break}}}}}if(modedItem.socketbonusstat&&status.weights&&status.weightsFactor!=0){for(var l in status.weights){if(status.weights.hasOwnProperty(l)&&modedItem.socketbonusstat[l]){sock+=modedItem.socketbonusstat[l]*status.weights[l]/status.weightsFactor}}}item.scoreBest=best;item.scoreMatch=match+sock;item.scoreSocket=sock;if(item.scoreMatch>=item.scoreBest&&!noMatch){item.matchSockets=mSock;item.gemGain=item.scoreMatch;item.gems=mGems}else{item.matchSockets=bSock;item.gemGain=item.scoreBest;item.gems=bGems}item.score+=item.gemGain}if(item.score>listview._maxScore||!listview._maxScore){listview._maxScore=item.score}if(listview_isItemFromFindUpgrades(listview,item)){listview._minScore=item.score;item.upgraded=1}};this.weights_init=function(wrapper){var classSelect=WH.ce("select");classSelect.onchange=classSelect.onkeyup=weights_onChangeClass.bind(0,classSelect,0);WH.ae(classSelect,WH.ce("option"));if(g_user.weightscales!=null&&g_user.weightscales.length){var customOption=WH.ce("option");customOption.className="q1-alt";customOption.value=-1;customOption._presets={custom:{}};WH.ae(customOption,WH.ct(LANG.ficustom));WH.ae(classSelect,customOption);for(var i=0,len=g_user.weightscales.length;i<len;++i){customOption._presets.custom[g_user.weightscales[i].id]=g_user.weightscales[i]}}var classIds=[];for(var tempClassId in wt_presets){if(wt_presets.hasOwnProperty(tempClassId)){classIds.push(tempClassId)}}classIds.sort(function(a,b){return WH.stringCompare(g_chr_classes[a],g_chr_classes[b])});for(var k=0,classId;classId=classIds[k];k++){var classOption=WH.ce("option");classOption.value=classId;classOption.className="c"+classId+"-alt";classOption._presets=wt_presets[classId];WH.ae(classOption,WH.ct(g_chr_classes[classId]));WH.ae(classSelect,classOption)}WH.ae(wrapper,classSelect);var presetWrapper=WH.ce("span");presetWrapper.style.display="none";var presetSelect=WH.ce("select");presetSelect.id=constants.presetSpecId;presetSelect.onchange=presetSelect.onkeyup=weights_onChangePreset.bind(null,presetSelect);WH.ae(presetSelect,WH.ce("option"));WH.ae(presetWrapper,WH.ct(" "));WH.ae(presetWrapper,presetSelect);WH.ae(wrapper,presetWrapper);WH.ae(wrapper,WH.ct(String.fromCharCode(160,160)));var optionsLink=WH.ce("a");optionsLink.className="fa fa-cog";optionsLink.href="javascript:;";optionsLink.id="filters-weights-options";optionsLink.appendChild(WH.ct(LANG.fishowdetails));optionsLink.onclick=self.weights_togglePresetOptions;WH.ae(wrapper,optionsLink);if(g_user.id>0){WH.ae(wrapper,WH.ct(String.fromCharCode(160,160)));var saveLink=WH.ce("a");saveLink.href="javascript:;";saveLink.className="fa fa-save";saveLink.appendChild(WH.ct(LANG.fisavescale));saveLink.onclick=weights_savePreset;WH.ae(wrapper,saveLink);WH.ae(wrapper,WH.ct(String.fromCharCode(160,160)));var deleteLink=WH.ce("a");deleteLink.href="javascript:;";deleteLink.id="filters-weights-delete";deleteLink.className="fa fa-times";deleteLink.style.display="none";deleteLink.appendChild(WH.ct(LANG.fideletescale));deleteLink.onclick=weights_deletePreset;WH.ae(wrapper,deleteLink)}var helpLink=WH.ge("gnjndfgkjdfg35");if(helpLink){WH.Tooltip.simple(helpLink,LANG.tooltip_statweighting,"q")}};this.weights_set=function(weights,nt,ids,stealth){if(ids){var weightFilters=weights[0],weightFilterValues=weights[1];weights={};for(var i=0,weightFilter;weightFilter=weightFilters[i];i++){var a=self.filters_lookup(weightFilter);if(a&&a.type=="num"&&!a.noweights&&LANG.traits[a.name]){weights[a.name]=weightFilterValues[i]}}}var weightsWrapper=WH.ge(constants.elementIds.weightsWrapper);if(status.weights==null){status.weights={};WH.cO(status.weights,weights)}var weightsSelector=weightsWrapper.childNodes[0].childNodes[0];var j=0;for(var k in weights){if(!weights.hasOwnProperty(k)||!LANG.traits[k]){continue}if(j++>0){weightsSelector=self.filters_add(weightsWrapper,k)}var options=weightsSelector.getElementsByTagName("option");for(var l=0,option;option=options[l];l++){if(option.value&&k==self.filters_lookup(option.value).name){option.selected=true;break}}filters_onChange(weightsSelector,0,weights[k])}status.weightsFactor=weights_convert(weights,true);if(!nt){if(!weights_check(weights,stealth)){self.weights_togglePresetOptions()}}};this.weights_togglePresetOptions=function(){var weightsWrapper=WH.ge(constants.elementIds.weightsWrapper);var presetOptions=WH.ge("filters-weights-options");var addWeightLink=WH.ge("filters-weights-add");addWeightLink.style.display="none";if(WH.toggleDisplay(weightsWrapper)){if(LANG.fihidedetails){presetOptions.firstChild.nodeValue=LANG.fihidedetails;presetOptions.style.display="inline"}else{presetOptions.style.display="none"}if(weightsWrapper.childNodes.length<19){addWeightLink.style.display=""}}else{if(LANG.fishowdetails){presetOptions.firstChild.nodeValue=LANG.fishowdetails;presetOptions.style.display="inline"}else{presetOptions.style.display="none"}}return false};this.utility_checkFilterContent=function(){var $this=$(this);var $clearLink=$("#"+$this.attr("id")+"-clear-link");if($this.val()){$this.removeClass("no-content").addClass("has-content");$clearLink.css("visibility","visible")}else{if(!$this.hasClass("no-content")){$this.addClass("no-content").removeClass("has-content");$clearLink.css("visibility","hidden")}}};this.utility_updateSelectClass=function(){if(this.selectedIndex>=0){if(this.lastClass){this.className=this.className.replace(new RegExp(" *\\b"+this.lastClass+"\\b"),"")}var newClass=this.options[this.selectedIndex].className;if(newClass){this.lastClass=newClass;this.className+=" "+this.lastClass}else{delete this.lastClass}}};this.utility_cleanEmptyFilterSelectGroups=function(){var selects=document.getElementById(constants.elementIds.filtersWrapper).getElementsByTagName("select");var firstFilterSelect;for(var i=0,select;select=selects[i];i++){if(select.name==constants.elementNames.filterType){firstFilterSelect=select;break}}if(!firstFilterSelect){return}var options=firstFilterSelect.getElementsByTagName("option");for(var j=0,option;option=options[j];j++){var id=option.value;for(var k=0,filter;filter=status.filters[k];k++){if(filter.id&&filter.id==id&&filter.type){var parts=filter.type.split("-");var criteriaName=parts[0];var criteriaParams=parts[1]||"";if((typeof LANG.fidropdowns[criteriaName]=="object")&&(LANG.fidropdowns[criteriaName].length==0)){option.parentNode.removeChild(option);j--;break}}}}var optGroups=firstFilterSelect.getElementsByTagName("optgroup");for(var l=0,optGroup;optGroup=optGroups[l];l++){if(optGroup.childNodes.length==0){optGroup.parentNode.removeChild(optGroup);l--}}};function filters_setAll(){if(!status.presetFilters.length){return}var filterWrapper=WH.ge(constants.elementIds.filtersWrapper);var firstFilterSelector=filterWrapper.childNodes[0].childNodes[0];var options=firstFilterSelector.getElementsByTagName("option");var filterSettings;for(var i=0,option;option=options[i];i++){if(option.value==status.presetFilters[0].id){option.selected=true;if(filterSettings=self.filters_lookup(status.presetFilters[0].id)){WH.Track.nonInteractiveEvent("Filters",status.page,filterSettings.name)}break}}filters_onChange(firstFilterSelector,status.presetFilters[0].select,status.presetFilters[0].value);var filterPreset;for(var j=1;(filterPreset=status.presetFilters[j])&&j<constants.maxFilters;j++){filters_onChange(self.filters_add(filterWrapper,filterPreset.id),filterPreset.select,filterPreset.value);if(filterSettings=self.filters_lookup(filterPreset.id)){WH.Track.nonInteractiveEvent("Filters",status.page,filterSettings.name)}}filters_updateAdditionalInput();filters_updateFilterCount()}function filters_onChange(filterSelector,filterSelect,filterValue){if(filterSelect&&filterSelect instanceof Event){filterSelect=null}var removeLink=filterSelector.parentNode.getElementsByClassName("removelink");if(removeLink.length){removeLink[0].style.display=filterSelector.selectedIndex==0?"none":""}if(filterSelector.i==filterSelector.selectedIndex){return}var option=filterSelector.options[filterSelector.selectedIndex];var filterDiv=filterSelector.parentNode;if(filterDiv.childNodes.length>1){if(filterSelector.selectedIndex>0&&filterSelector.i>0){var newFilter=self.filters_lookup(option.value);var currentFilter=self.filters_lookup(filterSelector.options[filterSelector.i].value);if(newFilter.type==currentFilter.type){filters_updateAdditionalInput();return}}while(filterDiv.childNodes.length>1){filterDiv.removeChild(filterDiv.childNodes[1])}}if(filterSelector.selectedIndex>0){var filter=self.filters_lookup(option.value);var parts=filter.type.split("-");var criteriaName=parts[0];var criteriaParams=parts[1]||"";var isPatchFilter=false;if(filterSelector.name==constants.elementNames.filterType&&criteriaName=="patch"){isPatchFilter=true;criteriaName="num"}var dropdown=LANG.fidropdowns[criteriaName];if(dropdown){if(filterSelector.name==constants.elementNames.filterType){var filterSelectElement=WH.ce("select");filterSelectElement.name=constants.elementNames.filterSelect;var dropdownItem;if(criteriaParams.indexOf("other")!=-1){if(filterSelect!=null&&(typeof filterSelect!="object")){var foundInCriteria=false;for(var i=0;dropdownItem=dropdown[i];i++){if(dropdownItem[0]==filterSelect){foundInCriteria=true;break}}if(!foundInCriteria){LANG.fidropdowns[criteriaName].push([filterSelect,LANG.other+" ("+filterSelect+")"])}}}if(filter.sortdropdown){dropdown.sort(function(a,b){return WH.stringCompare(filter.sortdropdown==1?a[1]:b[1],filter.sortdropdown==1?b[1]:a[1])})}if(criteriaParams.indexOf("any")!=-1){var anyOption=WH.ce("option");anyOption.value="-2323";anyOption.appendChild(WH.ct(LANG.fiany));WH.ae(filterSelectElement,anyOption);if(filterSelect!=null&&filterSelect=="-2323"){anyOption.selected=true}}for(var j=0;dropdownItem=dropdown[j];j++){if(dropdown[j][0]!==null){if(!filter.firstBuild||filter.firstBuild<=dropdown[j][0]){var dropdownOption=WH.ce("option");dropdownOption.value=dropdown[j][0];dropdownOption.appendChild(WH.ct(dropdown[j][1]));WH.ae(filterSelectElement,dropdownOption);if((filterSelect!==null&&filterSelect==dropdown[j][0])||(filterSelect===null&&criteriaName==="num"&&dropdown[j][1]===">=")){dropdownOption.selected=true}}}else{var optGroup=WH.ce("optgroup");optGroup.label=dropdown[j][1];WH.ae(filterSelectElement,optGroup);if(criteriaParams.indexOf("Anybycat")!=-1){var anyByCatOption=WH.ce("option");anyByCatOption.value=dropdown[j][2];anyByCatOption.appendChild(WH.ct(LANG.fiany));WH.ae(optGroup,anyByCatOption);if(filterSelect!=null&&filterSelect==dropdown[j][2]){anyByCatOption.selected=true}}}}if(criteriaParams.indexOf("none")!=-1){var noneOrOtherOption=WH.ce("option");noneOrOtherOption.value="-2324";noneOrOtherOption.appendChild(WH.ct((criteriaParams.indexOf("any")!=-1)?LANG.finone:LANG.other));WH.ae(filterSelectElement,noneOrOtherOption);if(filterSelect!=null&&filterSelect=="-2324"){noneOrOtherOption.selected=true}}utility_enableFilterContentChecks(filterSelectElement);filterDiv.appendChild(WH.ct(" "));filterDiv.appendChild(filterSelectElement)}var isNumFilter=criteriaName=="num";if(isNumFilter){filterDiv.appendChild(WH.ct(" "))}var filterValueElement;if(isPatchFilter){filterValueElement=WH.ce("select");filters_generateDropdowns();for(var k=0,patch;patch=filterDropdowns.patches[k];k++){var patchOption=WH.ce("option");var version=patch.split(".");if(!filter.firstExpansion||filter.firstExpansion<=version[0]){if(criteriaParams.indexOf("date")!=-1){patchOption.value=filterDropdowns.patchDates[patch]}else{patchOption.value=(version[0]*1000)+(version[1]*10)+version[2]}patchOption.appendChild(WH.ct(patch));WH.ae(filterValueElement,patchOption);if(filterValue!=null&&filterValue==patchOption.value){patchOption.selected=true}}}}else{filterValueElement=WH.ce("input");filterValueElement.type="text";if(filterValue!=null){filterValueElement.value=filterValue.toString()}else{filterValueElement.value=filter.hasOwnProperty("default")?filter["default"]:"0"}if(filter.hasOwnProperty("placeholder")){filterValueElement.placeholder=filter.placeholder}}if(filterSelector.name==constants.elementNames.filterType){filterValueElement.name=constants.elementNames.filterValue}else{filterValueElement.name="weight-values[]";filterValueElement.onchange=weights_onChange.bind(filterValueElement)}if(isNumFilter){filterValueElement.maxLength=criteriaParams.indexOf("large")!=-1?12:7;if(!isPatchFilter){filterValueElement.style.textAlign="center";filterValueElement.style.width=criteriaParams.indexOf("large")!=-1?"7.7em":"4.5em"}}else{filterValueElement.type="hidden"}filterValueElement.setAttribute("autocomplete","off");utility_enableFilterContentChecks(filterValueElement);filterDiv.appendChild(filterValueElement);if(filterSelector.name=="weights[]"){weights_sort(filterValueElement)}}else{if(criteriaName=="str"){var hiddenSelect=WH.ce("input");hiddenSelect.name=constants.elementNames.filterSelect;hiddenSelect.type="hidden";hiddenSelect.value="0";filterDiv.appendChild(hiddenSelect);var strInput=WH.ce("input");strInput.type="text";if(criteriaParams.indexOf("small")!=-1){strInput.maxLength=7;strInput.style.textAlign="center";strInput.style.width="4.5em"}else{strInput.maxLength=50;strInput.style.width="9em"}strInput.name=constants.elementNames.filterValue;if(filterValue!=null){strInput.value=filterValue}utility_enableFilterContentChecks(strInput);filterDiv.appendChild(WH.ct(" "));filterDiv.appendChild(strInput)}}}if(filterDiv.parentNode.childNodes.length>1){filters_appendRemoveLink(filterDiv)}filterSelector.i=filterSelector.selectedIndex;$(filterSelector).change();filters_updateAdditionalInput();filters_updateFilterCount()}function filters_updateAdditionalInput(){var filterWrapper=WH.ge(constants.elementIds.filtersWrapper);var selects=filterWrapper.getElementsByTagName("select");var filterCount=0;var empty=null;for(var i=0,select;select=selects[i];i++){if(select.name!=constants.elementNames.filterType){continue}filterCount++;if(select.selectedIndex==0){empty=select.parentNode}}if(empty){if(filterCount<constants.maxFilters){WH.ae(empty.parentNode,empty)}else{WH.de(empty)}}else{if(filterCount<constants.maxFilters){self.filters_add(filterWrapper)}}}function filters_remove(){var filterDiv=this.parentNode;var filterWrapper=filterDiv.parentNode;var weights=filterDiv.firstChild.name=="weights[]";filterWrapper.removeChild(filterDiv);if(weights){var specPresets=WH.ge(constants.presetSpecId);specPresets.selectedIndex=0;specPresets.i=0;$(specPresets).change();weights_check()}if(filterWrapper.id==constants.elementIds.filtersWrapper){filters_updateAdditionalInput()}filters_updateFilterCount()}function filters_reset(){var filterDiv=this.parentNode;filterDiv.firstChild.selectedIndex=0;filters_onChange(filterDiv.firstChild);filters_updateFilterCount()}function filters_appendRemoveLink(target,hidden){var a=WH.ce("a");a.className="filter-remove";a.href="javascript:;";a.appendChild(WH.ct(LANG.firemove));a.onclick=filters_remove;if(hidden){a.style.display="none"}target.appendChild(a)}function filters_generateDropdowns(){WH.Wow.getPatchVersionObject();var builds=[];for(var build in g_wow_builds){if(!g_wow_builds.hasOwnProperty(build)){continue}filterDropdowns.patches.push(g_wow_builds[build].version);builds.push(build)}filterDropdowns.patches=filterDropdowns.patches.sort().reverse();builds=builds.sort();for(var x=0;x<builds.length;x++){var o=g_wow_builds[builds[x]];var n=(x+1==builds.length)?{timestamp:4000000000000}:g_wow_builds[builds[x+1]];filterDropdowns.patchDates[o.version]=Math.floor(o.timestamp/1000)+"-"+Math.floor(n.timestamp/1000)}filters_generateDropdowns=function(){}}function filters_resetAll(filterWrapper){if(filterWrapper!=null){var filterDiv;while(filterWrapper.childNodes.length>1){filterDiv=filterWrapper.childNodes[1];while(filterDiv.childNodes.length>1){filterDiv.removeChild(filterDiv.childNodes[1])}filterWrapper.removeChild(filterDiv)}filterDiv=filterWrapper.childNodes[0];while(filterDiv.childNodes.length>1){filterDiv.removeChild(filterDiv.childNodes[1])}filterDiv.firstChild.i=null;filterDiv.firstChild.selectedIndex=0;$(filterDiv.firstChild).change();if(filterWrapper.nextSibling.firstChild){filterWrapper.nextSibling.firstChild.style.display=filterWrapper.style.display}filters_updateFilterCount()}}function filters_updateFilterCount(){var filterCount=0;$(".filter-filters > div > select:first-child").each(function(){if($(this).val()){filterCount++}});$(".filter-filters-wrapper").attr("data-filters",filterCount)}function listview_isItemFromFindUpgrades(listview,item){if(listview._upgradeIds&&WH.inArray(listview._upgradeIds,item.id)!=-1){if(listview._upgradeIdBonuses&&listview._upgradeIdBonuses.length>0){if(!item.bonuses||item.bonuses.length!=listview._upgradeIdBonuses.length){return false}else{for(var j in item.bonuses){if(WH.inArray(listview._upgradeIdBonuses,item.bonuses[j])==-1){return false}}}}return true}return false}function weights_onChange(){if($("#"+constants.elementIds.presetsWrapper+" select option:selected").val()!=-1){var specPresets=WH.ge(constants.presetSpecId);specPresets.selectedIndex=0;specPresets.i=0}weights_sort(this);weights_check()}function weights_sort(select){var weightsWrapper=WH.ge(constants.elementIds.weightsWrapper);var value=Number(select.value);var selectWrapper=select.parentNode;var count=0;for(var i=0,weightsDiv;weightsDiv=weightsWrapper.childNodes[i];i++){if(weightsDiv.childNodes.length==5){count++;if(weightsDiv.childNodes[2].nodeName=="INPUT"&&value>Number(weightsDiv.childNodes[2].value)){weightsWrapper.insertBefore(selectWrapper,weightsDiv);return}}}weightsWrapper.insertBefore(selectWrapper,weightsWrapper.childNodes[count])}function weights_convert(weights,getFactor){var factor=0;for(var i in weights){if(!weights.hasOwnProperty(i)||!LANG.traits[i]){continue}factor+=Math.abs(weights[i])}if(getFactor){return factor}var result={};for(var j in weights){if(weights.hasOwnProperty(j)){result[j]=LANG.traits[j]?(Math.round(1000*weights[j]/factor)/1000):weights[j]}}return result}function weights_convertScore(score,mode,maxScore){if(mode==1){return parseInt(score*status.weightsFactor)}else{if(mode==2){return((score/maxScore)*100).toFixed(1)+"%"}else{return score.toFixed(2)}}}function weights_updateScores(e){if(++this._scoreMode>2){this._scoreMode=0}for(var i=0,data;data=this.data[i];i++){if(data.__tr){var cell=data.__tr.lastChild;cell.firstChild.firstChild.nodeValue=weights_convertScore(data.score,this._scoreMode,this._maxScore)}}e.stopPropagation()}function weights_onChangeClass(classSelector,stealth){Filter.utility_updateSelectClass.call(classSelector);if(classSelector.i==classSelector.selectedIndex){return}var preset;var c=classSelector.options[classSelector.selectedIndex];var specPresets=WH.ge(constants.presetSpecId);specPresets.parentNode.style.display="none";var oldValue=1000;if(classSelector.i){oldValue=$($("#"+constants.elementIds.presetsWrapper+" select option")[classSelector.i]).val()}if(!stealth&&(classSelector.form["class"].selectedIndex==0||classSelector.form["class"].value==oldValue)){$('select[name="class"] option[value='+classSelector.value+"]").prop("selected",true).change()}while(specPresets.firstChild){WH.de(specPresets.firstChild)}WH.ae(specPresets,WH.ce("option"));if(classSelector.selectedIndex>0){for(preset in c._presets){if(!c._presets.hasOwnProperty(preset)){continue}var weights=c._presets[preset];var groupInt=parseInt(preset);var hasOptGroup=false;var group;if(LANG.presets[preset]!=null||groupInt){group=WH.ce("optgroup");group.label=LANG.presets[preset]!=null?LANG.presets[preset]:WH.sprintf(LANG.presets.ilvlformat.replace("%s","$1"),groupInt);hasOptGroup=true}else{group=specPresets}for(var p in weights){if(!weights.hasOwnProperty(p)){continue}var option=WH.ce("option");option.value=p;option._weights=weights[p];WH.ae(option,WH.ct(weights[p].name?weights[p].name:LANG.presets[p]));WH.ae(group,option);if(groupInt){option._ilvl=groupInt}}if(hasOptGroup&&group&&group.childNodes.length>0){WH.ae(specPresets,group)}}if(specPresets.childNodes.length>1){specPresets.parentNode.style.display=""}}$(specPresets).removeClass("has-content").addClass("no-content");weights_onChangePreset(specPresets);classSelector.i=classSelector.selectedIndex}function weights_onChangePreset(presetSelector){if(presetSelector.i==presetSelector.selectedIndex){return}filters_resetAll(WH.ge(constants.elementIds.weightsWrapper));var option=presetSelector.options[presetSelector.selectedIndex];if(presetSelector.selectedIndex>0){if(presetSelector.form.elements["gem-quality"].selectedIndex==0){presetSelector.form.elements["gem-quality"].selectedIndex=2;$(presetSelector.form.elements["gem-quality"]).change()}filters_resetAll(WH.ge(constants.elementIds.weightsWrapper));self.weights_set(option._weights,1,0)}presetSelector.i=presetSelector.selectedIndex;if(g_user.id>0){var a=WH.ge("filters-weights-delete");a.style.display=(option._weights&&option._weights.name?"":"none")}}function weights_check(weights,stealth){if(!weights){weights={};var weightsWrapper=WH.ge(constants.elementIds.weightsWrapper);for(var i=0,weightDiv;weightDiv=weightsWrapper.childNodes[i];i++){if(weightDiv.childNodes.length==5){if(weightDiv.childNodes[0].nodeName=="SELECT"&&weightDiv.childNodes[2].nodeName=="INPUT"){var node=weightDiv.childNodes[0].options[weightDiv.childNodes[0].selectedIndex];if(node.value){weights[self.filters_lookup(node.value)]=Number(weightDiv.childNodes[2].value)}}}}}var selects=WH.ge(constants.elementIds.presetsWrapper).getElementsByTagName("select");if(selects.length!=2){return false}var convertedWeights=weights_convert(weights);for(var j=0,classOption;classOption=selects[0].options[j];j++){if(selects[0].form["class"].value&&classOption.value!=selects[0].form["class"].value){continue}for(var g in classOption._presets){if(!classOption._presets.hasOwnProperty(g)){continue}for(var v in classOption._presets[g]){if(!classOption._presets[g].hasOwnProperty(v)){continue}var convertedPresets=weights_convert(classOption._presets[g][v]);var match=true;var hasWeights=false;for(var weightI in convertedPresets){if(!convertedPresets.hasOwnProperty(weightI)||!LANG.traits[weightI]){continue}hasWeights=true;if(!convertedWeights[weightI]||convertedPresets[weightI]!=convertedWeights[weightI]){match=false;break}}if(match&&hasWeights){classOption.selected=true;$(selects[0]).removeClass("no-content").addClass("has-content");weights_onChangeClass(selects[0],stealth);for(var k=0,specOption;specOption=selects[1].options[k];k++){if(specOption._ilvl&&specOption._ilvl!=g){continue}if(v==specOption.value){specOption.selected=true;$(selects[1]).removeClass("no-content").addClass("has-content");weights_onChangePreset(selects[1]);break}}return true}}}}return false}function weights_savePreset(){if(!g_user.id){return}var specPresets=WH.ge(constants.presetSpecId);var weightOption=$("option:selected",specPresets).get(0);var name="";var id=(weightOption._weights?weightOption._weights.id:0)|0;var scale={id:id,name:name};var weightsWrapper=WH.ge(constants.elementIds.weightsWrapper);var count=0;for(var i=0,weightDiv;weightDiv=weightsWrapper.childNodes[i];++i){var weightFilter=self.filters_lookup($('[name="weights[]"]',weightDiv).val());var weightFilterValue=$('[name="weight-values[]"]',weightDiv).val();if(weightFilter&&weightFilterValue!=0){scale[weightFilter.name]=weightFilterValue;count++}}if(count<1||(!(weightOption._weights&&weightOption._weights.id)&&g_user.weightscales&&g_user.weightscales.length>=5)){return alert(LANG.message_weightscalesaveerror)}if(name=prompt(LANG.prompt_nameweightscale,$(weightOption).text())){var data={save:1,name:WH.urlEncode(name),scale:""};if(id){data.id=id}scale.name=name;count=0;for(var w in scale){if(!scale.hasOwnProperty(w)||!LANG.traits[w]){continue}if(count++>0){data.scale+=","}data.scale+=w+":"+scale[w]}$.post("/account=weightscales",data,function(response){if(response<=0){alert(LANG.message_weightscalesaveerror);return}if(!g_user.weightscales){g_user.weightscales=[]}if(scale.id){g_user.weightscales=WH.arrayFilter(g_user.weightscales,function(x){return x.id!=scale.id})}scale.id=response;g_user.weightscales.push(scale);var presetClassSelector=$("#"+constants.elementIds.presetsWrapper+" select").get(0);var customClassOption=$("option[value=-1]",presetClassSelector).get(0);if(!customClassOption){customClassOption=WH.ce("option");customClassOption.value=-1;WH.ae(customClassOption,WH.ct(LANG.ficustom));WH.aef(presetClassSelector,customClassOption);WH.aef(presetClassSelector,$("option",presetClassSelector).get(1))}customClassOption._presets={custom:{}};for(var i=0,userScale;userScale=g_user.weightscales[i];i++){customClassOption._presets.custom[userScale.id]=userScale}customClassOption.selected=true;customClassOption.parentNode.onchange();var option=$("option[value="+scale.id+"]",specPresets).get(0);if(option){option.text=scale.name;option.selected=true;option.parentNode.onchange()}})}}function weights_deletePreset(){if(!g_user.id){return}var presetClassSelector=$("#"+constants.elementIds.presetsWrapper+" select").get(0);var currentClassSelection=$("option:selected",presetClassSelector).get(0);if(currentClassSelection.value!=-1){return}var weightOption=$("#"+constants.presetSpecId+" option:selected").get(0);if(!weightOption.value||!confirm(LANG.confirm_deleteweightscale)){return}$.post("/account=weightscales",{"delete":1,id:weightOption.value});g_user.weightscales=WH.arrayFilter(g_user.weightscales,function(x){return x.id!=weightOption.value});if(g_user.weightscales.length){currentClassSelection._presets={custom:{}};for(var i=0,userScale;userScale=g_user.weightscales[i];i++){currentClassSelection._presets.custom[userScale.id]=userScale}}else{WH.de(currentClassSelection)}WH.de(weightOption);$("#"+constants.elementIds.presetsWrapper+" select").change()}function utility_updateMenus(){if(!status.menuPath||!status.menuPath.length||($.isEmptyObject(status.presetFacets)&&!status.presetFilters.length)){return}Menu.modifyUrl(Menu.findItem(mn_path,status.menuPath),{},{custom:function(url,menuItem){if(menuItem[MENU_IDX_OPT]&&menuItem[MENU_IDX_OPT].noFilterModifications){return url}var activeFacetCategories={};var basePath=[];var categoryPath=[];var otherArguments=[];var facets=$.extend({},status.presetFacets);var filters=$.extend([],status.presetFilters);var getFilter=function(filterId){for(var i=0,filter;filter=status.filters[i];i++){if(filter.id==filterId){return filter}}};var newFilters=[];for(var p=0,presetFilter;presetFilter=filters[p];p++){var filterConfig=getFilter(presetFilter.id);if(filterConfig&&filterConfig.doNotModifyMenu){continue}newFilters.push(presetFilter)}filters=newFilters;var getFacet=function(facetId){for(var i=0,facet;facet=status.facets[i];i++){if(facet.id==facetId){return facet}}};var newFacets={};for(var facetId in facets){if(!facets.hasOwnProperty(facetId)){continue}var presetFacetConfig=getFacet(facetId);if(presetFacetConfig&&presetFacetConfig.doNotModifyMenu){continue}newFacets[facetId]=facets[facetId]}facets=newFacets;var baseParts=url.split("?",2);var getCategorySettings=function(urlSegment,lastCategory){for(var i=0,category;category=lastCategory.categories[i];i++){if(category.url==urlSegment){return category}}};var slashParts=baseParts[0].split("/");var noMoreCategories=false;var lastCategory=null;for(var i=0,len=slashParts.length;i<len;i++){var facet=slashParts[i].split(":",2);if(facet.length==2){noMoreCategories=true;facets[facet[0]]={id:facet[0],value:facet[1]}}else{if(!noMoreCategories){basePath.push(facet[0]);if(i==0&&facet[0]==""){continue}if(i==1&&facet[0]==status.page){lastCategory={categories:status.categories};continue}var categorySettings=getCategorySettings(facet[0],lastCategory?lastCategory:{categories:status.categories});if(categorySettings){categoryPath.push(categorySettings);lastCategory=categorySettings;if(categorySettings.facet){activeFacetCategories[categorySettings.facet]=true}}else{noMoreCategories=true}}}}if(baseParts[1]){var arguments=baseParts[1].split("&");for(var j=arguments.length-1,argument;argument=arguments[j];j--){var filter=argument.match(/^filter=([0-9:]+);([-0-9:]+);(.*)/);if(filter){var ids=filter[1].split(":");var selects=filter[2].split(":");var values=filter[3].split(":");for(var k=0,id;id=ids[k];k++){for(var o=0,existingFilter;existingFilter=filters[o];o++){if(existingFilter.id==ids[k]){filters.splice(o,1);break}}filters.unshift({id:ids[k],select:selects[k],value:values[k]})}}else{otherArguments.push(argument)}}}url=basePath.join("/");if(!$.isEmptyObject(facets)){for(var l=0,facetConfig;facetConfig=status.facets[l];l++){if(facets[facetConfig.id]){if(facetConfig.categoryTier){if(activeFacetCategories[facetConfig.id]||facetConfig.categoryTier.level!=categoryPath.length){continue}}if(facetConfig.condition){var conditionPasses=true;switch(facetConfig.condition.type){case"category":for(var m=0,category;category=facetConfig.condition.category[m];m++){if(!categoryPath[m]||categoryPath[m].id!=category){conditionPasses=false;break}}break}if(!conditionPasses){continue}}url+="/"+facetConfig.id+(facets[facetConfig.id].extended&&facets[facetConfig.id].extended.value?"-extended":"")+":"+utility_prepareValueForUrl(facets[facetConfig.id].value,true)}}}if(filters.length){var filterIds=[];var filterSelects=[];var filterValues=[];for(var n=0;filter=filters[n];n++){filterIds.push(utility_prepareValueForUrl(filter.id));filterSelects.push(utility_prepareValueForUrl(filter.select));filterValues.push(utility_prepareValueForUrl(filter.value))}url+="?filter="+filterIds.join(":")+";"+filterSelects.join(":")+";"+filterValues.join(":")}if(otherArguments.length){url+=(filters.length?"&":"?")+otherArguments.join("&")}return url},returnAfterCustom:true})}function utility_enableFilterContentChecks(target){$(target).on(constants.checkFilterContentEvents,self.utility_checkFilterContent).each(self.utility_checkFilterContent)}function utility_focusFirstTextInput(){if(location.hash.length){return}var $firstInput=$("#fi form input:first");if($firstInput.is(":text")){WH.safeFocus($firstInput)}}function utility_prepareValueForUrl(string,allowColons){var value=encodeURIComponent(string);if(allowColons){value=value.replace(/%3A/g,":")}value=value.replace(/%20/g,"+").replace(/%26/g,"%2526").replace(/%3D/g,"%253D");return value}function compareFilterObjects(){if(!WH.isDev()||typeof fi_filters=="undefined"||!fi_filters[status.page]||$.isEmptyObject(fi_filters[status.page])){return}var differences={};var filterComparison=function(index,a,b,translations){var aProps=Object.getOwnPropertyNames(a);var bProps=Object.getOwnPropertyNames(b);if(aProps.length!=bProps.length){differences[index]={type:"length",objects:[a,b]};return}for(var i=0;i<aProps.length;i++){var propName=aProps[i];var secondPropName=translations[propName]||propName;if(a[propName]!==b[secondPropName]){differences[index]={type:"values",objects:[a,b],property:propName==secondPropName?propName:propName+" -VS- "+secondPropName,values:[a[propName],b[secondPropName]]}}}};var groupComparison=function(a,b,translations){if(a.length!=b.length){console.warn("The old and new filter JS options are different lengths!",a.length,b.length,a,b);differences.lengths={type:"overall lengths",arrays:[a,b]};return}for(var i=0,aObj;aObj=a[i];i++){filterComparison(i,aObj,b[i],translations)}};groupComparison(fi_filters[status.page],status.filters,{staffonly:"staffOnly"});groupComparison(status.filters,fi_filters[status.page],{staffOnly:"staffonly"});if($.isEmptyObject(differences)){console.info("The old and new filter JS options are equivalent!")}else{console.warn("Found differences in the old and new filter JS options!",differences)}}};